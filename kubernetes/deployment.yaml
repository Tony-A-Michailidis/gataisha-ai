# kubernetes/deployment.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: cato-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cato-agent
  namespace: cato-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cato-agent-reader
rules:
  # Read cluster configuration
  - apiGroups: [""]
    resources: ["namespaces", "pods", "services", "configmaps", "secrets"]
    verbs: ["get", "list"]
  
  # Read RBAC configuration
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
    verbs: ["get", "list"]
  
  # Read Network Policies
  - apiGroups: ["networking.k8s.io"]
    resources: ["networkpolicies"]
    verbs: ["get", "list"]
  
  # Read Pod Security Policies (if enabled)
  - apiGroups: ["policy"]
    resources: ["podsecuritypolicies"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cato-agent-reader-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cato-agent-reader
subjects:
  - kind: ServiceAccount
    name: cato-agent
    namespace: cato-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cato-agent-config
  namespace: cato-system
data:
  EVIDENCE_STORAGE_PATH: "/app/evidence"
  LOG_LEVEL: "INFO"
  API_HOST: "0.0.0.0"
  API_PORT: "8000"
---
apiVersion: v1
kind: Secret
metadata:
  name: cato-agent-secrets
  namespace: cato-system
type: Opaque
stringData:
  AZURE_SUBSCRIPTION_ID: "your-subscription-id"
  AZURE_RESOURCE_GROUP: "your-resource-group"
  AKS_CLUSTER_NAME: "your-cluster-name"
  # For Managed Identity, these are not needed
  # AZURE_CLIENT_ID: ""
  # AZURE_CLIENT_SECRET: ""
  # AZURE_TENANT_ID: ""
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cato-evidence-pvc
  namespace: cato-system
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: managed-premium
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cato-agent
  namespace: cato-system
  labels:
    app: cato-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cato-agent
  template:
    metadata:
      labels:
        app: cato-agent
        aadpodidbinding: cato-agent-identity  # For AAD Pod Identity
    spec:
      serviceAccountName: cato-agent
      containers:
        - name: cato-agent
          image: your-registry/cato-agent:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
              name: http
          env:
            - name: EVIDENCE_STORAGE_PATH
              valueFrom:
                configMapKeyRef:
                  name: cato-agent-config
                  key: EVIDENCE_STORAGE_PATH
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: cato-agent-config
                  key: LOG_LEVEL
            - name: AZURE_SUBSCRIPTION_ID
              valueFrom:
                secretKeyRef:
                  name: cato-agent-secrets
                  key: AZURE_SUBSCRIPTION_ID
            - name: AZURE_RESOURCE_GROUP
              valueFrom:
                secretKeyRef:
                  name: cato-agent-secrets
                  key: AZURE_RESOURCE_GROUP
            - name: AKS_CLUSTER_NAME
              valueFrom:
                secretKeyRef:
                  name: cato-agent-secrets
                  key: AKS_CLUSTER_NAME
          volumeMounts:
            - name: evidence-storage
              mountPath: /app/evidence
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /api/health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: evidence-storage
          persistentVolumeClaim:
            claimName: cato-evidence-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: cato-agent
  namespace: cato-system
  labels:
    app: cato-agent
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    app: cato-agent
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cato-agent
  namespace: cato-system
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
    - hosts:
        - cato.yourdomain.com
      secretName: cato-agent-tls
  rules:
    - host: cato.yourdomain.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: cato-agent
                port:
                  number: 80
---
# Optional: CronJob for scheduled assessments
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cato-assessment-job
  namespace: cato-system
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cato-agent
          restartPolicy: OnFailure
          containers:
            - name: assessment
              image: curlimages/curl:latest
              command:
                - /bin/sh
                - -c
                - curl -X POST http://cato-agent.cato-system.svc.cluster.local/api/assess